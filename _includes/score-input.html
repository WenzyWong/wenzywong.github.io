{% comment %}
Include: _includes/score-input.html
This part renders the IELTS practice input form and allows syncing to GitHub Gist.
{% endcomment %}

<div class="input-section">
  <label>Date:
    <input type="date" id="practiceDate" required>
  </label>
  <label>Category:
    <select id="category" required>
      <option value="">-- Select --</option>
      <option value="Reading">Reading</option>
      <option value="Listening">Listening</option>
      <option value="Writing">Writing</option>
      <option value="Speaking">Speaking</option>
    </select>
  </label>
  <label>Score:
    <input type="number" id="score" min="0" max="9" step="0.5" required>
  </label>
</div>
<button onclick="submitScore()">Submit</button>

<script>
function submitScore() {
  const token = localStorage.getItem('gh_token');
  const gistId = '{{ page.score_gist_id }}';
  if (!token || !gistId) {
    alert('Missing token or gistId.');
    return;
  }

  const date = document.getElementById('practiceDate').value;
  const category = document.getElementById('category').value;
  const score = parseFloat(document.getElementById('score').value);

  if (!date || !category || isNaN(score)) {
    alert('Please complete all fields.');
    return;
  }

  const newEntry = { id: Date.now(), date, category, score };

  fetch(`https://api.github.com/gists/${gistId}`, {
    method: 'GET',
    headers: {
      'Authorization': `token ${token}`,
      'Accept': 'application/vnd.github.v3+json'
    }
  })
  .then(res => res.json())
  .then(gist => {
    const file = gist.files['ielts-scores.json'];
    const content = file && file.content ? JSON.parse(file.content) : [];
    content.push(newEntry);
    return fetch(`https://api.github.com/gists/${gistId}`, {
      method: 'PATCH',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        files: {
          'ielts-scores.json': {
            content: JSON.stringify(content, null, 2)
          }
        }
      })
    });
  })
  .then(() => {
    alert('Score submitted!');
    document.getElementById('category').value = '';
    document.getElementById('score').value = '';
    if (typeof updateChart === 'function') updateChart([...practiceData, newEntry]);
    if (typeof updateStats === 'function') updateStats([...practiceData, newEntry]);
  })
  .catch(err => {
    console.error(err);
    alert('Failed to submit score.');
  });
}

// Set today's date by default
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('practiceDate').value = new Date().toISOString().split('T')[0];
});
</script>

<style>
.input-section {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  margin: 20px 0;
}
.input-section label {
  display: flex;
  flex-direction: column;
  font-weight: 600;
}
button {
  padding: 10px 20px;
  background: linear-gradient(135deg, #27ae60, #2ecc71);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
}
</style>
