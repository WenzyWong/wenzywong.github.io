{% comment %} 
Include: _includes/score-chart.html
This part renders the IELTS practice score chart.
{% endcomment %}

<div class="chart-container">
  <canvas id="scoreChart"></canvas>
</div>

<div class="stats-grid" id="statsGrid"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
let chart;
let practiceData = [];

async function fetchGistData(token, gistId, filename = 'ielts-scores.json') {
  const response = await fetch(`https://api.github.com/gists/${gistId}`, {
    headers: {
      'Authorization': `token ${token}`,
      'Accept': 'application/vnd.github.v3+json'
    }
  });
  if (!response.ok) throw new Error('Failed to fetch gist');
  const gist = await response.json();
  return JSON.parse(gist.files[filename].content || '[]');
}

function updateChart(data) {
  const ctx = document.getElementById('scoreChart').getContext('2d');
  if (chart) chart.destroy();
  const categories = ['Reading', 'Listening', 'Writing', 'Speaking'];
  const colors = ['#3498db', '#2ecc71', '#f39c12', '#e74c3c'];
  const datasets = categories.map((cat, i) => {
    const points = data.filter(e => e.category === cat)
                       .sort((a, b) => new Date(a.date) - new Date(b.date))
                       .map(e => ({ x: e.date, y: e.score }));
    return {
      label: cat,
      data: points,
      borderColor: colors[i],
      backgroundColor: colors[i] + '20',
      borderWidth: 3,
      fill: false,
      tension: 0.1,
      pointRadius: 5,
      pointHoverRadius: 7
    };
  });

  chart = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'time',
          time: { unit: 'day' },
          title: { display: true, text: 'Practice Date' }
        },
        y: {
          min: 0, max: 9,
          title: { display: true, text: 'Score' }
        }
      },
      plugins: {
        title: { display: true, text: 'IELTS Practice Score Progress' },
        legend: { position: 'top' }
      }
    }
  });
}

function updateStats(data) {
  const statsGrid = document.getElementById('statsGrid');
  statsGrid.innerHTML = '';
  const categories = ['Reading', 'Listening', 'Writing', 'Speaking'];
  categories.forEach(cat => {
    const scores = data.filter(e => e.category === cat).map(e => e.score);
    if (scores.length > 0) {
      const avg = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
      const latest = scores[scores.length - 1];
      statsGrid.innerHTML += `
        <div class="stat-card">
          <div class="stat-value">${avg}</div>
          <div class="stat-label">${cat} Average</div>
          <div style="font-size: 0.8em; margin-top: 5px;">Latest: ${latest}</div>
        </div>`;
    }
  });
  if (data.length > 0) {
    const overall = (data.reduce((sum, e) => sum + e.score, 0) / data.length).toFixed(1);
    statsGrid.innerHTML += `
      <div class="stat-card" style="background: linear-gradient(135deg,#667eea,#764ba2)">
        <div class="stat-value">${overall}</div>
        <div class="stat-label">Overall Average</div>
        <div style="font-size: 0.8em; margin-top: 5px;">Total: ${data.length} practices</div>
      </div>`;
  }
}

// Load and render chart after DOM content loaded
window.addEventListener('DOMContentLoaded', async () => {
  const token = localStorage.getItem('gh_token');
  const gistId = '{{ page.score_gist_id }}';
  if (!token || !gistId) return;
  try {
    practiceData = await fetchGistData(token, gistId);
    updateChart(practiceData);
    updateStats(practiceData);
  } catch (e) {
    console.error('Failed to load chart:', e);
  }
});
</script>

<style>
.chart-container {
  position: relative;
  height: 400px;
  margin: 30px 0;
}
.stat-card {
  background: linear-gradient(135deg,#3498db,#2980b9);
  color: white;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  margin: 10px;
}
.stat-value {
  font-size: 2em;
  font-weight: bold;
}
.stat-label {
  font-size: 0.9em;
  opacity: 0.9;
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin: 20px 0;
}
</style>
